# Summary

The Objective of this document is to deploy a AWS Network firewall using a distributed deployment model and propagate the alerts generated by the firewall manger to a configurable Slack channel.

# Key Elements and Challenges

## Elements discussed

- Integrating Network firewall generated alerts to Slack for further action.
- Network firewall Distributed deployment model

## Challenges

VPCs are considered same as a physical network when it comes to compliance regimes such as PCI-DSS. Workloads runs on VPCs that are governed by a compliance regime can be protected using AWS Network Firewall, any unauthorized access from the other VPCs of the same account can be blocked or alerted. AWS Network firewall support limited number of destinations for delivering the generated alerts. However, these destinations act as a log destinations, any further action on these alerts requires a post log offline analysis either using Athena or Kinesis. This solution provides a method where NFW generated alert can be propagated to other systems for further action in a near real time basis. This solution also provides a platform

## Solution

Network firewall can be used monitor and control network traffic between VPCs, ingress and egress flow. Network Firewall manager generated alerts can be delivered to S3 or Cloud watch log group or Kinesis data firehose. There are no out of the box options to deliver the alerts other than the above three destinations. This solution provides an option to deliver the alerts to a configurable Slack channel.

The solution can also be used as a template or a platform to extend the alert delivery to other platforms such as JIRA, text or email etc.,

### Prerequisites:

This solution assumes that user already

1. Has a slack channel
2. Has the required privileges to send a slack message
3. In possession of the slack endpoint url with the token.

[Refer this link for creating new slack workspace](https://slack.com/help/articles/206845317-Create-a-Slack-workspace)

### What is Included in the solution?

All the resources that fall under the &quot;Region&quot; box in the above diagram are included in this solution. These resources will be automatically provisioned automatically though the CloudFormation templates and the source code required for the Lambda also included in the bundle.

At the end of the CloudFormation execution the following AWS resources will be provisioned.

1. Vpc
2. Subnets – 4 ( 2 subnets dedicated for FW and 2 for workloads)
3. Internet gateway
4. Route tables with rules – 4
5. S3 bucket for Network firewall alert destination
6. S3 – Event configuration to Trigger Lambda
7. S3 – Bucket policy
8. Lambda Execution role
9. Lambda function to send Slack notifications
10. Secret manager Secret for storing Slack url
11. Network Firewall with alert configuration

### What is not Included in the solution?

1. Creating Slack channel
2. Test EC2 instance in the workload subnets
3. Test rules in Network Firewall
4. Actual or simulated traffic to trigger the test rules.
5. S3 bucket to hold the source files to be deployed.

### How does this solution work?

This solution provides 2 protected subnets (Protected Subnet), 2 Network Firewall endpoint will be provisioned on the dedicated subnets (Firewall Subnet), all traffic going in and out of the protected subnets can be monitored by [creating FW policies](https://docs.aws.amazon.com/waf/latest/developerguide/network-firewall-policies.html) and rules. The Network firewall is configured to place all alerts to a S3 bucket. This S3 bucket is configured to invoke a Lambda function upon any &#39;put&#39; event in the bucket. This Lambda fetches the configured slack url from Secret Manager and sends the notification message when invoked from S3.

### Components of this Solution:

1. A set of CloudFormation files in Yaml format.
2. Python source file for Lambda function.
3. Compressed Python source file.

### How to Deploy:

1. Create new or use an existing s3 bucket
2. Copy the following files to the above bucket (prefix recommended) from [source location](https://gitlab.aws.dev/vramaam/security-aod10-vramaam.git)
  1. base.yml
  2. igw-ingress-route.yml
  3. slack-lambda.py
  4. slackLambda.yml
  5. decentralized-deployment.yml
  6. protected-subnet-route.yml
  7. slack-lambda.py.zip
3. Using console create a stack by choosing base.yml.

#### Deployment Parameters: 
Refer : docs/NfwAlerts_Slack_Integration.docx
